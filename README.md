# Maverick Marketplace

This project is integrated with [Appwrite](https://appwrite.io) for backend services.

## Get started

1. Install dependencies

   ```bash
   npm install
   ```

2. Set up environment variables

   Create a `.env` file in the root directory with the following content:

   ```
   EXPO_PUBLIC_APPWRITE_ENDPOINT=http://localhost/v1
   EXPO_PUBLIC_APPWRITE_PROJECT_ID=your-project-id # Update after creating project in Appwrite
   EXPO_PUBLIC_APPWRITE_PLATFORM=com.company.MaverickMarketPlace # Update with your app's platform/bundle ID
   ```

   This file will be automatically ignored by git to protect your sensitive information.

3. Set up Appwrite Backend

   Follow these steps to set up your Appwrite backend:

   a. Navigate to the `appwrite` directory:
   ```bash
   cd appwrite
   ```

   b. Create the `.env` file **only if it doesn't already exist**, using the content below or the template in `appwrite/README.md`:

   > ðŸ“Œ Skip this step if `appwrite/.env` already exists.

   ```
   # Appwrite Environment Variables

   # Environment mode: production or development
   _APP_ENV=development

   # Appwrite console configuration
   _APP_CONSOLE_WHITELIST_ROOT=enabled
   _APP_CONSOLE_WHITELIST_EMAILS=
   _APP_CONSOLE_WHITELIST_IPS=
   _APP_SYSTEM_EMAIL_NAME=Maverick Marketplace
   _APP_SYSTEM_EMAIL_ADDRESS=noreply@maverick.local

   # Security
   _APP_OPENSSL_KEY_V1=your-secret-key
   _APP_USAGE_STATS=enabled
   _APP_OPTIONS_ABUSE=enabled
   _APP_OPTIONS_FORCE_HTTPS=disabled  # Set to enabled for production
   _APP_DOMAIN=localhost
   _APP_DOMAIN_TARGET=localhost

   # Database credentials
   _APP_DB_HOST=mariadb
   _APP_DB_PORT=3306
   _APP_DB_SCHEMA=appwrite
   _APP_DB_USER=appwrite
   _APP_DB_PASS=appwrite-password
   _APP_DB_ROOT_PASS=appwrite-root-password

   # Redis configuration
   _APP_REDIS_HOST=redis
   _APP_REDIS_PORT=6379
   _APP_REDIS_USER=
   _APP_REDIS_PASS=

   # Storage limits
   _APP_STORAGE_LIMIT=10000000
   _APP_STORAGE_PREVIEW_LIMIT=20000000
   _APP_STORAGE_ANTIVIRUS=disabled

   # Functions configuration
   _APP_FUNCTIONS_SIZE_LIMIT=30000000
   _APP_FUNCTIONS_TIMEOUT=900
   _APP_FUNCTIONS_BUILD_TIMEOUT=900
   _APP_FUNCTIONS_CPUS=1
   _APP_FUNCTIONS_MEMORY=1024
   _APP_FUNCTIONS_RUNTIMES=node-18.0,php-8.1,python-3.10,ruby-3.1,dart-2.17

   # Executor configuration
   _APP_EXECUTOR_SECRET=your-executor-secret
   _APP_EXECUTOR_HOST=http://openruntimes-executor:3000

   # SMTP configuration (for email sending)
   _APP_SMTP_HOST=
   _APP_SMTP_PORT=
   _APP_SMTP_SECURE=
   _APP_SMTP_USERNAME=
   _APP_SMTP_PASSWORD=
   ```

   c. Start Appwrite using Docker Compose:
   ```bash
   docker-compose up -d
   ```

   This will start all the Appwrite services in detached mode. The first startup may take some time as it downloads the necessary Docker images.

   d. Access the Appwrite Console at http://localhost/console

   e. Create your project:
      - Create a new project named "Maverick Marketplace"
      - Note the project ID and update it in your root `.env` file's `EXPO_PUBLIC_APPWRITE_PROJECT_ID` value

4. Set up the database, collections, and storage

   a. Create an API key:
      - In the Appwrite Console, go to your project â†’ API Keys 
      - Create a new API key with full access permissions
      - Copy the API key

   b. Update the `appwrite-setup/setup.js` file:
      - Open the file and update the `client.setProject()` value with your project ID
      - Update the `client.setKey()` value with your API key

   c. Install dependencies for the setup script:
   ```bash
   cd appwrite-setup
   npm install
   ```

   d. Run the setup script:
   ```bash
   node setup.js
   ```

   The script will:
   - Create a database
   - Create collections for users, listings, and images
   - Add all required attributes and indexes
   - Create a storage bucket for listing images
   - Print out the IDs for all created resources

   e. Update the `appwrite/config.ts` file:
   
   Copy the constants displayed at the end of the setup script output and replace the values in `appwrite/config.ts` with the ones generated by the script:

   ```typescript
   export const DATABASE_ID = 'your-database-id';
   export const USERS_COLLECTION_ID = 'your-users-collection-id';
   export const LISTINGS_COLLECTION_ID = 'your-listings-collection-id';
   export const IMAGES_COLLECTION_ID = 'your-images-collection-id';
   export const IMAGES_BUCKET_ID = 'listing-images';
   ```

5. Start the development server

   ```bash
   npm start
   ```

   You can open the app on your device using the Expo Go app by scanning the QR code displayed in your terminal.

   For web development:
   ```bash
   npm run web
   ```

## Project Structure

- `appwrite/`: Appwrite configuration
  - `config.ts`: Appwrite client configuration 
  - `docker-compose.yml`: Docker Compose setup for Appwrite services
- `appwrite-setup/`: Database and collection setup scripts
  - `setup.js`: Node.js script for setting up database and collections
- `.env`: App environment variables (not committed to git)
- `appwrite/.env`: Appwrite environment variables (not committed to git)

## Working with Images

The app supports uploading and displaying images for listings. Images are stored in the Appwrite Storage bucket created during setup (`listing-images`).

When uploading images:
- Images are first selected from the device's media library using Expo Image Picker
- They are then uploaded to the Appwrite Storage bucket
- Reference information is stored in the `images` collection, linking the image to a specific listing

When displaying images:
- The app retrieves image references from the `images` collection
- It then uses the Appwrite Storage service to generate preview URLs
- The images are rendered using Expo Image component with proper caching controls

## Development Notes

1. For development, we're using http://localhost. For production, make sure to:
   - Update to https
   - Set _APP_OPTIONS_FORCE_HTTPS=enabled
   - Use a proper domain name

2. When testing on physical devices:
   - You'll need to update the Appwrite endpoint in `.env` to use your computer's IP address instead of localhost
   - Ensure your device is on the same network as your development machine

3. For Android development, you may need to modify network security configuration to allow clear-text traffic during development.